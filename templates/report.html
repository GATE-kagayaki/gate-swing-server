<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GATE AIスイングドクター｜SWING ANALYSIS REPORT</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@600;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Noto Sans JP', sans-serif; background:#f3f4f6; }
    .paper { background:#fff; max-width:980px; margin:20px auto; padding:28px; box-shadow: 0 10px 20px rgba(0,0,0,0.06); border-radius: 16px; }
    h2 { border-left:4px solid #111827; padding-left:12px; margin-top:28px; font-weight:700; font-family: 'Noto Serif JP', serif; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th,td { border:1px solid #e5e7eb; padding:10px; font-size: 0.95rem; vertical-align: top; }
    th { background:#f9fafb; font-weight: 700; width: 34%; }
    .loading { text-align: center; padding: 90px 0; }
    .card { border: 1px solid #e5e7eb; border-radius: 14px; padding: 14px; background: #fff; }
    .muted { color:#6b7280; font-size: 0.88rem; line-height: 1.6; }
    .lead { color:#111827; line-height: 1.8; }
    .badge { display:inline-block; padding:4px 10px; border-radius: 999px; background:#111827; color:#fff; font-size: 12px; }
    .sp { margin-top: 10px; }
    .list li { margin: 6px 0; }
  </style>
</head>

<body>
<div class="paper">

  <div class="text-center">
    <h1 class="text-2xl font-bold">GATE AIスイングドクター</h1>
    <p class="text-sm text-gray-500 mt-1">SWING ANALYSIS REPORT</p>
  </div>

  <div class="mt-6 flex items-center justify-between gap-3">
    <div class="text-xs text-gray-500">
      REPORT ID：<span id="reportId" class="font-mono"></span>
    </div>
    <div id="premiumBadge" class="hidden">
      <span class="badge">PRO REPORT</span>
    </div>
  </div>

  <div id="loading" class="loading">
    <div class="animate-spin h-8 w-8 border-4 border-gray-500 rounded-full border-t-transparent mx-auto"></div>
    <p class="mt-4 text-gray-500 text-sm">レポートデータを読み込み中...</p>
  </div>

  <div id="report-content" class="hidden"></div>

</div>

<script>
  const reportId = location.pathname.split("/").pop();
  document.getElementById("reportId").innerText = reportId;

  const reportContent = document.getElementById("report-content");
  const loadingEl = document.getElementById("loading");
  const premiumBadge = document.getElementById("premiumBadge");

  function sectionWrap(title) {
    const sec = document.createElement("section");
    sec.className = "mt-7";
    const h2 = document.createElement("h2");
    h2.textContent = title;
    sec.appendChild(h2);
    return sec;
  }

  function render01(secData) {
    const sec = sectionWrap(secData.title);
    const table = document.createElement("table");
    const tbody = document.createElement("tbody");

    secData.items.forEach(it => {
      const tr = document.createElement("tr");
      const th = document.createElement("th");
      th.textContent = it.name;

      const td = document.createElement("td");
      td.innerHTML = `
        <div class="lead font-bold">${it.value}</div>
        <div class="muted sp">${it.description}</div>
        <div class="muted sp">目安：<span class="font-semibold text-gray-700">${it.guide}</span></div>
      `;

      tr.appendChild(th);
      tr.appendChild(td);
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    sec.appendChild(table);
    reportContent.appendChild(sec);
  }

  function render02to06(key, secData) {
    const sec = sectionWrap(secData.title);

    const v = document.createElement("div");
    v.className = "muted mt-2";
    v.innerHTML = `解析結果：<span class="font-semibold text-gray-800">${secData.value}</span>`;
    sec.appendChild(v);

    const grid = document.createElement("div");
    grid.className = "grid grid-cols-1 md:grid-cols-2 gap-3 mt-3";

    const good = document.createElement("div");
    good.className = "card";
    good.innerHTML = `<div class="font-bold">良い点</div>
      <ul class="list list-disc pl-5 mt-2">${(secData.good||[]).map(x=>`<li>${x}</li>`).join("")}</ul>`;

    const bad = document.createElement("div");
    bad.className = "card";
    bad.innerHTML = `<div class="font-bold">改善が期待できる点</div>
      <ul class="list list-disc pl-5 mt-2">${(secData.bad||[]).map(x=>`<li>${x}</li>`).join("")}</ul>`;

    grid.appendChild(good);
    grid.appendChild(bad);
    sec.appendChild(grid);

    if (secData.pro_comment) {
      const pc = document.createElement("div");
      pc.className = "card mt-3";

      let proHtml = "";
      if (Array.isArray(secData.pro_comment)) {
        proHtml = secData.pro_comment.map(t => `<p class="lead">${t}</p>`).join("");
      } else {
        proHtml = `<p class="lead">${secData.pro_comment}</p>`;
      }

      pc.innerHTML = `<div class="font-bold">プロ目線</div><div class="mt-2">${proHtml}</div>`;
      sec.appendChild(pc);
    }

    reportContent.appendChild(sec);
  }

  function render08(secData) {
    const sec = sectionWrap(secData.title);
    const table = document.createElement("table");
    table.innerHTML = `
      <thead>
        <tr>
          <th>ドリル名</th>
          <th>目的</th>
          <th>やり方</th>
        </tr>
      </thead>
      <tbody>
        ${(secData.drills||[]).map(d=>`
          <tr>
            <td class="font-semibold">${d.name}</td>
            <td>${d.purpose}</td>
            <td class="whitespace-pre-line">${d.how}</td>
          </tr>
        `).join("")}
      </tbody>`;
    sec.appendChild(table);
    reportContent.appendChild(sec);
  }

  function render09(secData) {
    const sec = sectionWrap(secData.title);
    const table = document.createElement("table");
    table.innerHTML = `
      <thead>
        <tr>
          <th>項目</th>
          <th>推奨</th>
          <th>理由</th>
        </tr>
      </thead>
      <tbody>
        ${(secData.table||[]).map(r=>`
          <tr>
            <td class="font-semibold">${r.item}</td>
            <td>${r.guide}</td>
            <td>${r.reason}</td>
          </tr>
        `).join("")}
      </tbody>`;
    sec.appendChild(table);

    if (secData.note) {
      const note = document.createElement("div");
      note.className = "muted mt-2";
      note.textContent = secData.note;
      sec.appendChild(note);
    }
    reportContent.appendChild(sec);
  }

  function renderTextSection(secData) {
    const sec = sectionWrap(secData.title);
    const box = document.createElement("div");
    box.className = "card mt-3";
    box.innerHTML = (secData.text || []).map(t => {
      if (t === "") return `<div class="h-3"></div>`;
      return `<p class="lead">${t}</p>`;
    }).join("");
    sec.appendChild(box);
    reportContent.appendChild(sec);
  }

  fetch(`/api/report_data/${reportId}`)
    .then(r => r.json())
    .then(data => {
      loadingEl.classList.add("hidden");
      if (String(data.status).toUpperCase() === "COMPLETED") {
        reportContent.classList.remove("hidden");
        if (data.is_premium) premiumBadge.classList.remove("hidden");
        const a = data.analysis || {};
        if (a["01"]) render01(a["01"]);
        ["02","03","04","05","06"].forEach(k => a[k] && render02to06(k, a[k]));
        if (a["07"]) renderTextSection(a["07"]);
        if (a["08"]) render08(a["08"]);
        if (a["09"]) render09(a["09"]);
        if (a["10"]) renderTextSection(a["10"]);
      }
    });
</script>
</body>
</html>
