<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GATE AIスイングドクター｜SWING ANALYSIS REPORT</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@600;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

 <style>
    /* 既存のベーススタイルを維持 */
    body { font-family: 'Noto Sans JP', sans-serif; background:#f3f4f6; }
    .paper { background:#fff; max-width:980px; margin:20px auto; padding:28px; box-shadow: 0 10px 20px rgba(0,0,0,0.06); border-radius: 16px; }
    h2 { border-left:4px solid #111827; padding-left:12px; margin-top:28px; font-weight:700; font-family: 'Noto Serif JP', serif; }
    
    /* 既存のテーブルスタイル（01〜06などで使用される可能性があるため保持） */
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th,td { border:1px solid #e5e7eb; padding:10px; font-size: 0.95rem; vertical-align: top; }
    th { background:#f9fafb; font-weight: 700; width: 34%; }
    
    .loading { text-align: center; padding: 90px 0; }
    .card { border: 1px solid #e5e7eb; border-radius: 14px; padding: 14px; background: #fff; }
    .muted { color:#6b7280; font-size: 0.88rem; line-height: 1.6; }
    .lead { color:#111827; line-height: 1.8; }
    .badge { display:inline-block; padding:4px 10px; border-radius: 999px; background:#111827; color:#fff; font-size: 12px; }
    .sp { margin-top: 10px; }
    .list li { margin: 6px 0; }

    /* ==================================================
       【追加】08, 09 セクション用：カード型レイアウト
       ================================================== */
    /* カードを縦に並べるコンテナ */
    .gate-card-list {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
        margin-top: 1rem;
    }

    /* 個別のカード（09：フィッティング / 08：ドリル用） */
    .gate-spec-card {
        background: #ffffff;
        border: 1px solid #e5e7eb; /* 既存の .card と統一感を持たせる */
        border-radius: 1rem;
        padding: 1.25rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        border-left: 6px solid #28a745; /* GATEカラーのアクセント */
    }

    /* 項目名などのラベル */
    .card-label {
        font-size: 0.75rem;
        font-weight: bold;
        color: #9ca3af;
        text-transform: uppercase;
        margin-bottom: 0.25rem;
    }

    /* 推奨スペック（元調子、50gなど）の強調表示 */
    .card-value {
        font-size: 1.25rem;
        font-weight: 800;
        color: #111827;
        margin-bottom: 0.75rem;
        display: block;
    }

    /* 理由・手順などの解説ボックス */
    .card-reason-box {
        font-size: 0.95rem;
        line-height: 1.7;
        color: #4b5563;
        background-color: #f9fafb;
        padding: 1rem;
        border-radius: 0.75rem;
        white-space: pre-wrap; /* Pythonの \n を改行として表示するために必須 */
    }
</style>
</head>

<body>
<div class="paper">

  <div class="text-center">
    <h1 class="text-2xl font-bold">GATE AIスイングドクター</h1>
    <p class="text-sm text-gray-500 mt-1">SWING ANALYSIS REPORT</p>
  </div>

  <div class="mt-6 flex items-center justify-between gap-3">
    <div class="text-xs text-gray-500">
      REPORT ID：<span id="reportId" class="font-mono"></span>
    </div>
    <div id="premiumBadge" class="hidden">
      <span class="badge">PRO REPORT</span>
    </div>
  </div>

  <div id="loading" class="loading">
    <div class="animate-spin h-8 w-8 border-4 border-gray-500 rounded-full border-t-transparent mx-auto"></div>
    <p class="mt-4 text-gray-500 text-sm">レポートデータを読み込み中...</p>
  </div>

  <div id="report-content" class="hidden"></div>

</div>

<script>
  const parts = location.pathname.split("/").filter(Boolean);
　const reportId = parts[parts.length - 1];

  document.getElementById("reportId").innerText = reportId;

  const reportContent = document.getElementById("report-content");
  const loadingEl = document.getElementById("loading");
  const premiumBadge = document.getElementById("premiumBadge");

  function sectionWrap(title) {
    const sec = document.createElement("section");
    sec.className = "mt-7";
    const h2 = document.createElement("h2");
    h2.textContent = title;
    sec.appendChild(h2);
    return sec;
  }

  function render01(secData) {
    const sec = sectionWrap(secData.title);
    const table = document.createElement("table");
    const tbody = document.createElement("tbody");

    secData.items.forEach(it => {
      const tr = document.createElement("tr");
      const th = document.createElement("th");
      th.textContent = it.name;

      const td = document.createElement("td");
      td.innerHTML = `
        <div class="lead font-bold">${it.value}</div>
        <div class="muted sp">${it.description}</div>
        <div class="muted sp">目安：<span class="font-semibold text-gray-700">${it.guide}</span></div>
      `;

      tr.appendChild(th);
      tr.appendChild(td);
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    sec.appendChild(table);
    reportContent.appendChild(sec);
  }

  function render02to06(key, secData) {
    const sec = sectionWrap(secData.title);

    const v = document.createElement("div");
    v.className = "muted mt-2";
    v.innerHTML = `解析結果：<span class="font-semibold text-gray-800">${secData.value}</span>`;
    sec.appendChild(v);

    const grid = document.createElement("div");
    grid.className = "grid grid-cols-1 md:grid-cols-2 gap-3 mt-3";

    const good = document.createElement("div");
    good.className = "card";
    good.innerHTML = `<div class="font-bold">良い点</div>
      <ul class="list list-disc pl-5 mt-2">${(secData.good||[]).map(x=>`<li>${x}</li>`).join("")}</ul>`;

    const bad = document.createElement("div");
    bad.className = "card";
    bad.innerHTML = `<div class="font-bold">改善が期待できる点</div>
      <ul class="list list-disc pl-5 mt-2">${(secData.bad||[]).map(x=>`<li>${x}</li>`).join("")}</ul>`;

    grid.appendChild(good);
    grid.appendChild(bad);
    sec.appendChild(grid);

    if (secData.pro_comment) {
      const pc = document.createElement("div");
      pc.className = "card mt-3";

      let proHtml = "";
      if (Array.isArray(secData.pro_comment)) {
        proHtml = secData.pro_comment.map(t => `<p class="lead">${t}</p>`).join("");
      } else {
        proHtml = `<p class="lead">${secData.pro_comment}</p>`;
      }

      pc.innerHTML = `<div class="font-bold">プロ目線</div><div class="mt-2">${proHtml}</div>`;
      sec.appendChild(pc);
    }

    reportContent.appendChild(sec);
  }

function render08(secData) {
  const sec = sectionWrap(secData.title);

  // ✅ 通常の08（カード型レイアウト）
  const drillList = document.createElement("div");
  drillList.className = "gate-card-list";
  drillList.innerHTML = (secData.drills || []).map(d => `
    <div class="gate-spec-card" style="border-left-color: #007bff;">
      <div>
        <div class="card-label">RECOMMENDED DRILL</div>
        <span class="card-value">${d.name}</span>
      </div>
      <div class="card-reason-box">
        <div class="font-bold text-xs text-gray-400 mb-1">【目的】</div>
        <div class="mb-3">${d.purpose}</div>
        <div class="font-bold text-xs text-gray-400 mb-1">【手順】</div>
        <div>${d.how}</div>
      </div>
    </div>
  `).join("");
  
  sec.appendChild(drillList);
  reportContent.appendChild(sec);
}

function render09(secData) {
  const sec = sectionWrap(secData.title);

  // ✅ 入力が無い場合（空の09）
  if (secData.empty) {
    const box = document.createElement("div");
    box.className = "card mt-3 muted whitespace-pre-line";
    box.textContent = secData.message || "この項目は任意入力です。";
    sec.appendChild(box);
    reportContent.appendChild(sec);
    return;
  }

  // ✅ 通常の09（カード型レイアウト）
  const cardList = document.createElement("div");
  cardList.className = "gate-card-list";
  cardList.innerHTML = (secData.table || []).map(r => `
    <div class="gate-spec-card">
      <div>
        <div class="card-label">項目: ${r.item}</div>
        <span class="card-value">${r.guide}</span>
      </div>
      <div class="card-reason-box">
        ${r.reason}
      </div>
    </div>
  `).join("");
  sec.appendChild(cardList);

  // ✅ 既存の注釈表示ロジックを維持
  if (secData.note) {
    const note = document.createElement("div");
    note.className = "muted mt-2";
    note.textContent = secData.note;
    sec.appendChild(note);
  }

  reportContent.appendChild(sec);
}

  function renderTextSection(secData) {
    const sec = sectionWrap(secData.title);
    const box = document.createElement("div");
    box.className = "card mt-3";
    box.innerHTML = (secData.text || []).map(t => {
      if (t === "") return `<div class="h-3"></div>`;
      return `<p class="lead">${t}</p>`;
    }).join("");
    sec.appendChild(box);
    reportContent.appendChild(sec);
  }

  fetch(`/api/report_data/${reportId}`)
    .then(r => r.json())
    .then(data => {
      loadingEl.classList.add("hidden");
      if (String(data.status).toUpperCase() === "COMPLETED") {
        reportContent.classList.remove("hidden");
        if (data.is_premium) premiumBadge.classList.remove("hidden");
        const a = data.analysis || {};
        if (a["01"]) render01(a["01"]);
        ["02","03","04","05","06"].forEach(k => a[k] && render02to06(k, a[k]));
        if (a["07"]) renderTextSection(a["07"]);
        if (a["08"]) render08(a["08"]);
        if (a["09"]) render09(a["09"]);
        if (a["10"]) renderTextSection(a["10"]);
      }
    });
</script>
</body>
</html>
