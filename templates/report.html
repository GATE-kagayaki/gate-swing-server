<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>GATE AIスイングドクター｜SWING ANALYSIS REPORT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 text-gray-800">
<div class="max-w-3xl mx-auto bg-white p-6 my-6 shadow">

  <h1 class="text-2xl font-bold text-center mb-1">
    GATE AIスイングドクター
  </h1>
  <p class="text-center text-sm text-gray-500 mb-6">
    SWING ANALYSIS REPORT
  </p>

  <p class="text-xs text-gray-400 mb-6">
    REPORT ID：<span id="reportId"></span>
  </p>

  <div id="loading" class="text-center py-12 text-gray-500">
    解析処理中です。完了までしばらくお待ちください...
  </div>

  <div id="report" class="hidden"></div>

</div>

<script>
const reportId = location.pathname.split("/").pop();
document.getElementById("reportId").textContent = reportId;

fetch(`/api/report_data/${reportId}`)
  .then(res => res.json())
  .then(data => {
    if (!data.analysis) return;

    document.getElementById("loading").classList.add("hidden");
    const report = document.getElementById("report");
    report.classList.remove("hidden");

    const isPremium = data.is_premium === true;
    const analysis = data.analysis;

    // 共通：01
    renderSection(report, "01", analysis["01"]);

    // 有料のみ：02〜06
    if (isPremium) {
      ["02","03","04","05","06"].forEach(key => {
        if (analysis[key]) renderSection(report, key, analysis[key]);
      });
    }

    // 07：無料／有料で内容切り替え
    if (analysis["07"]) {
      renderSection(report, "07", analysis["07"]);
    }

    // 無料版の最後に案内文
    if (!isPremium) {
      report.insertAdjacentHTML("beforeend", `
        <div class="mt-10 p-5 border border-gray-300 bg-gray-50 text-sm">
          <p class="font-bold mb-2">より詳しい分析をご希望の方へ</p>
          <p>
            本レポートでは、スイング全体の傾向を
            骨格データに基づいて評価しています。
          </p>
          <p class="mt-2">
            ご自身のスイングを深く理解したい方は、
            ぜひフルレポートをご活用ください。
          </p>
        </div>
      `);
    }
  });

function renderSection(container, key, section) {
  let html = `
    <section class="mt-8">
      <h2 class="text-lg font-bold border-l-4 border-gray-800 pl-3 mb-3">
        ${key}. ${section.title}
      </h2>
  `;

  if (section.data) {
    html += `<table class="w-full text-sm border">`;
    Object.entries(section.data).forEach(([k, v]) => {
      html += `
        <tr class="border-t">
          <th class="w-1/3 bg-gray-50 p-2 text-left">${k}</th>
          <td class="p-2">${v}</td>
        </tr>`;
    });
    html += `</table>`;
  }

  if (section.result) {
    html += `<p class="text-sm mb-2">計測結果：<strong>${section.result}</strong></p>`;
  }

  if (section.good || section.bad) {
    if (section.good) {
      html += `<p class="font-bold mt-3">良い点</p><ul class="list-disc ml-5">`;
      section.good.forEach(t => html += `<li>${t}</li>`);
      html += `</ul>`;
    }
    if (section.bad) {
      html += `<p class="font-bold mt-3">悪い点</p><ul class="list-disc ml-5">`;
      section.bad.forEach(t => html += `<li>${t}</li>`);
      html += `</ul>`;
    }
  }

  if (section.pro_comment) {
    html += `
      <p class="mt-3 text-sm text-gray-700">
        <strong>プロ評価：</strong>${section.pro_comment}
      </p>`;
  }

  if (section.text) {
    section.text.forEach(t => {
      html += `<p class="text-sm mt-2">${t}</p>`;
    });
  }

  html += `</section>`;
  container.insertAdjacentHTML("beforeend", html);
}
</script>
</body>
</html>
